name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version from VERSION file
        id: version
        run: |
          VERSION=$(cat VERSION)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Check if tag already exists
        id: tag_exists
        run: |
          TAG="v${{ steps.version.outputs.version }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úì Tag $TAG already exists, skipping release"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚úì Tag $TAG does not exist, will create release"
          fi

      - name: Generate changelog from commits
        if: steps.tag_exists.outputs.exists == 'false'
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Get the last tag (or use initial commit if no tags exist)
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            # First release - get all commits
            COMMIT_RANGE="HEAD"
            echo "‚ÑπÔ∏è First release, including all commits"
          else
            # Get commits since last tag
            COMMIT_RANGE="$LAST_TAG..HEAD"
            echo "‚ÑπÔ∏è Commits since $LAST_TAG"
          fi

          # Generate changelog from commits using conventional commit format
          cat > CHANGELOG_TEMP.md << 'EOF'
          ## [$VERSION] - $(date -u +'%Y-%m-%d')

          EOF

          # Parse commits and categorize them
          FEATURES=$(git log $COMMIT_RANGE --pretty=format:"%b %s" | grep -E "^feat(\(.+\))?:" | sed 's/^feat(\(.*\)): /- \1: /' | sed 's/^feat: /- /' | sort -u)
          FIXES=$(git log $COMMIT_RANGE --pretty=format:"%b %s" | grep -E "^fix(\(.+\))?:" | sed 's/^fix(\(.*\)): /- \1: /' | sed 's/^fix: /- /' | sort -u)
          DOCS=$(git log $COMMIT_RANGE --pretty=format:"%b %s" | grep -E "^docs(\(.+\))?:" | sed 's/^docs(\(.*\)): /- \1: /' | sed 's/^docs: /- /' | sort -u)
          PERF=$(git log $COMMIT_RANGE --pretty=format:"%b %s" | grep -E "^perf(\(.+\))?:" | sed 's/^perf(\(.*\)): /- \1: /' | sed 's/^perf: /- /' | sort -u)
          REFACTOR=$(git log $COMMIT_RANGE --pretty=format:"%b %s" | grep -E "^refactor(\(.+\))?:" | sed 's/^refactor(\(.*\)): /- \1: /' | sed 's/^refactor: /- /' | sort -u)
          BREAKING=$(git log $COMMIT_RANGE --pretty=format:"%b %s" | grep -E "^feat|^fix" | grep "BREAKING" | sed 's/.*BREAKING[^:]*: /- /' | sort -u)

          {
            if [ -n "$BREAKING" ]; then
              echo "### ‚ö†Ô∏è Breaking Changes"
              echo "$BREAKING"
              echo ""
            fi

            if [ -n "$FEATURES" ]; then
              echo "### ‚ú® Features"
              echo "$FEATURES"
              echo ""
            fi

            if [ -n "$FIXES" ]; then
              echo "### üêõ Bug Fixes"
              echo "$FIXES"
              echo ""
            fi

            if [ -n "$PERF" ]; then
              echo "### ‚ö° Performance"
              echo "$PERF"
              echo ""
            fi

            if [ -n "$REFACTOR" ]; then
              echo "### ‚ôªÔ∏è Refactoring"
              echo "$REFACTOR"
              echo ""
            fi

            if [ -n "$DOCS" ]; then
              echo "### üìö Documentation"
              echo "$DOCS"
              echo ""
            fi

            if [ -z "$FEATURES" ] && [ -z "$FIXES" ] && [ -z "$DOCS" ] && [ -z "$PERF" ] && [ -z "$REFACTOR" ] && [ -z "$BREAKING" ]; then
              echo "No significant changes since last release"
            fi
          } >> CHANGELOG_TEMP.md

          # Show generated changelog
          echo "Generated Changelog:"
          cat CHANGELOG_TEMP.md

          # Save for next step
          echo "content=$(cat CHANGELOG_TEMP.md)" >> $GITHUB_OUTPUT

      - name: Create git tag
        if: steps.tag_exists.outputs.exists == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a v${{ steps.version.outputs.version }} -m "Release version ${{ steps.version.outputs.version }}"
          git push origin v${{ steps.version.outputs.version }}
          echo "‚úì Tag v${{ steps.version.outputs.version }} created and pushed"

      - name: Create GitHub release
        if: steps.tag_exists.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          body: ${{ steps.changelog.outputs.content }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        if: steps.tag_exists.outputs.exists == 'false'
        run: |
          echo "‚úÖ Release v${{ steps.version.outputs.version }} created successfully"
          echo ""
          echo "üìç Release: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}"
          echo "üì¶ Package: https://pkg.go.dev/github.com/algebananazzzzz/planear@v${{ steps.version.outputs.version }}"
